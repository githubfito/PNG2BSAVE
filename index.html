<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Retro Graphics Converter (PNG Mode Fixed)</title>
    <style>
        body { font-family: 'Courier New', monospace; background: #1a1a1a; color: #0f0; display: flex; flex-direction: column; align-items: center; padding: 20px; position: relative; }
        .main-container { background: #333; padding: 20px; border: 2px solid #555; border-radius: 8px; text-align: center; width: 95%; max-width: 950px; margin-top: 20px; }
        
        /* Botonera */
        .mode-selection { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .mode-selection input { display: none; }
        .mode-selection label { padding: 10px 20px; background: #222; border: 1px solid #555; cursor: pointer; border-radius: 4px; transition: 0.2s; }
        .mode-selection input:checked + label { background: #aa00aa; color: #fff; border-color: #f0f; box-shadow: 0 0 10px #aa00aa; }
        
        /* Caja de descripci√≥n */
        .mode-desc-box { background: #002b36; border: 1px solid #268bd2; color: #eee; padding: 10px; margin-bottom: 20px; border-radius: 5px; font-size: 0.85em; width: 95%; margin-left:auto; margin-right:auto; box-shadow: inset 0 0 10px #000; }
        .mode-desc-title { font-weight: bold; color: #2aa198; display: block; margin-bottom: 5px; text-transform: uppercase; }

        .controls-area { background: #222; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 15px; }
        .settings-row { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; align-items: center; }
        select, button, input[type="file"], input[type="number"] { padding: 5px 10px; background: #444; color: #fff; border: 1px solid #666; cursor: pointer; }
        input[type="number"] { width: 60px; text-align: center; border: 1px solid #aa00aa; background: #220022; color:#fff; }
        button { background: #aa00aa; font-weight: bold; border: none; padding: 10px 20px; font-size: 1.1em; }
        button:disabled { background: #555; opacity: 0.5; cursor: not-allowed; }
        
        /* Grupo de tama√±o manual */
        .manual-size-group { display: flex; align-items: center; gap: 5px; background: #220022; padding: 5px 10px; border: 1px solid #550055; border-radius: 4px; }
        .manual-size-group input[type="number"]:disabled { opacity: 0.5; cursor: default; border-color: #555; background: #333; }

        .canvas-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
        .canvas-box { display: flex; flex-direction: column; align-items: center; }
        canvas { border: 2px solid #fff; background: #000; image-rendering: pixelated; width: auto; height: auto; max-width: 100%; }
        .aspect-cpc-m0, .aspect-cpc-m1, .aspect-cga, .aspect-vga { width: 640px; height: 400px; }
        .aspect-spec { width: 512px; height: 384px; }
        .label-tag { background: #000; color: #fff; padding: 2px 8px; font-size: 0.8em; margin-bottom: 5px; border-radius: 3px; }
        .code-block { background: #111; border: 1px solid #444; padding: 10px; text-align: left; margin-top: 20px; font-size: 0.8em; color: #ccc; overflow-x: auto; max-height: 400px; }
        .control-panel { display:none; border-left: 1px solid #555; padding-left: 15px; margin-left: 10px; }
        .credits-link { position: absolute; top: 15px; right: 20px; color: #666; text-decoration: none; font-size: 0.8rem; transition: color 0.3s; z-index: 1000; }
        .credits-link:hover { color: #aa00aa; text-shadow: 0 0 5px #aa00aa; }
        .asm-alert { color: #ff0; font-size: 0.9em; margin-top: 5px; display: none; }
        
        .size-selector-group { display: flex; gap: 10px; align-items: center; background: #442244; padding: 10px; border-radius: 4px; border: 1px solid #aa00aa; flex-wrap: wrap; justify-content: center;}
        .size-selector-group label { color: #f0f; font-size: 0.8em; font-weight: bold; text-transform: uppercase; }
        .divider { width: 1px; height: 30px; background: #aa00aa; margin: 0 10px; }
        .sheet-info { margin-top: 5px; font-size: 0.8em; color: #aaa; width: 100%; text-align: center; }

        .palette-display { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-top: 10px; padding: 10px; background: #111; border: 1px solid #444; border-radius: 4px; }
        .pal-swatch { display: flex; flex-direction: column; align-items: center; background: #222; border: 1px solid #555; padding: 3px; border-radius: 3px; min-width: 60px; }
        .pal-color { width: 30px; height: 15px; border: 1px solid #fff; margin-bottom: 3px; }
        .pal-text { font-size: 0.7em; color: #ccc; }
        
        .info-stats { font-size: 0.8em; color: #0ff; margin-bottom: 5px; display: block; border-bottom: 1px dashed #0ff; padding-bottom: 5px;}
    </style>
</head>
<body>

    <a href="https://github.com/githubfito/PNG2BSAVE/tree/main" target="_blank" class="credits-link">by Fitosoft 2025</a>

    <div class="main-container">
        <h1>Retro Graphics Converter</h1>
        <div class="mode-selection">
            <input type="radio" id="mCGA" name="mode" value="cga"> <label for="mCGA">CGA</label>
            <input type="radio" id="mSpec" name="mode" value="spec"> <label for="mSpec">Spectrum</label>
            <input type="radio" id="mCPC" name="mode" value="cpc"> <label for="mCPC">CPC (Screen)</label>
            <input type="radio" id="m8BP" name="mode" value="8bp" checked> <label for="m8BP">8BP (ASM)</label>
            <input type="radio" id="mVGA" name="mode" value="vga"> <label for="mVGA">VGA (M13h)</label>
            <input type="radio" id="mPNG" name="mode" value="pngAnalysis"> <label for="mPNG" style="border:1px dashed #0ff; color:#0ff;">PNG / Custom</label>
        </div>

        <div id="modeDescription" class="mode-desc-box">
            <span id="descTitle" class="mode-desc-title">MODO SELECCIONADO</span>
            <span id="descText">...</span>
        </div>

        <div class="controls-area">
            <div class="settings-row">
                <div>
                    <span class="label-tag">IMAGEN:</span>
                    <input type="file" id="fileInput" accept="image/*">
                </div>
                
                <div style="display:flex; flex-direction:column; gap:5px; align-items:flex-start;">
                    <div><input type="checkbox" id="chkResize" checked> <label for="chkResize">Estirar / Full</label></div>
                    
                    <div class="manual-size-group">
                        <input type="checkbox" id="chkCustomSize"> <label for="chkCustomSize" style="font-size:0.8em; cursor:pointer;">Tama√±o Manual:</label>
                        <input type="number" id="inpFinalW" value="320" disabled>
                        <span style="color:#aaa; font-size:0.8em;">x</span>
                        <input type="number" id="inpFinalH" value="200" disabled>
                    </div>
                </div>
            </div>

            <div class="settings-row" id="rowPngAnalysis" style="display:none; background:#002222; padding:10px; border:1px solid #0ff; flex-direction:column; gap:5px;">
                <span class="info-stats" id="lblImgStats">Carga una imagen para ver sus datos...</span>
                <div style="display:flex; gap:15px; align-items:center; justify-content:center;">
                    <label style="color:#fff;">Colores Objetivo:</label>
                    <input type="number" id="inpTargetColors" min="2" max="256" value="16">
                    <span style="font-size:0.7em; color:#aaa;">(Se ajustar√° a Paleta CPC)</span>
                </div>
            </div>

            <div class="settings-row" id="row8bp" style="display:none; background:#2a2a2a; padding:10px; border:1px dashed #aa00aa; flex-direction:column; gap:10px;">
                <div style="display:flex; gap:15px; align-items:center; flex-wrap:wrap;">
                    <span class="label-tag" style="color:#f0f">ARCHIVO ASM:</span>
                    <input type="file" id="asmInput" accept=".asm,.txt">
                    <div id="asmStatus" class="asm-alert">Esperando archivo ASM...</div>
                </div>
                
                <div id="sizeControls" class="size-selector-group" style="display:none;">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="checkbox" id="chkSpriteSheet">
                        <label for="chkSpriteSheet" style="color:#fff; cursor:pointer;">MODO SPRITESHEET</label>
                    </div>
                    <div class="divider"></div>
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <label style="color:#fff; font-size:0.7em;">TAMA√ëO UN SPRITE (PX)</label>
                        <div style="display:flex; gap:5px;">
                            <select id="selSizeX"></select>
                            <span style="color:#666">x</span>
                            <select id="selSizeY"></select>
                        </div>
                    </div>
                    <div id="gridInputs" style="display:none; align-items:center; gap:10px;">
                        <div class="divider"></div>
                        <div style="display:flex; flex-direction:column; align-items:center;">
                            <label style="color:#fff; font-size:0.7em;">CANTIDAD A EXTRAER</label>
                            <div style="display:flex; gap:5px; align-items:center;">
                                <label>Cols:</label> <input type="number" id="inpCols" min="1" value="1">
                                <label>Filas:</label> <input type="number" id="inpRows" min="1" value="1">
                            </div>
                        </div>
                    </div>
                    <div id="finalSizeInfo" class="sheet-info"></div>
                </div>
            </div>

            <div id="palettePanel" style="display:none; width:100%;">
                <span class="label-tag" style="background:#444; border:1px solid #777;">PALETA DETECTADA (Sugerencia):</span>
                <div id="paletteContainer" class="palette-display"></div>
            </div>

            <div class="settings-row" id="algosRow">
                <label>Dithering:</label>
                <select id="selDither">
                    <option value="bayer" selected>Bayer</option>
                    <option value="fs">Floyd-Steinberg</option>
                    <option value="jjn">Jarvis-Judice-Ninke</option>
                    <option value="none">Ninguno</option>
                </select>
                <div id="cpcControls" class="control-panel">
                    <label style="color:#f0f;">Modo CPC:</label> 
                    <select id="selCpcMode">
                        <option value="0">Modo 0 (16 Col)</option>
                        <option value="1">Modo 1 (4 Col)</option>
                        <option value="2">Modo 2 (2 Col)</option>
                    </select>
                </div>
                <div id="cgaControls" class="control-panel">
                    <select id="selCgaPal"><option value="p1">Paleta 1 (Cian)</option><option value="p2">Paleta 2 (Rojo)</option></select>
                </div>
                <div id="specControls" class="control-panel">
                    <input type="checkbox" id="chkMono"> <label for="chkMono">B/N</label>
                </div>
                <div id="vgaControls" class="control-panel">
                    <label style="color:#ff0;">Paleta:</label> 
                    <select id="selVgaType"><option value="opt">Optimizada (256)</option><option value="std">Est√°ndar (Web)</option></select>
                </div>
            </div>
            
            <div class="settings-row">
                <button id="btnDownload" disabled>üíæ Descargar Resultado</button>
            </div>
            
            <div id="status">Esperando imagen...</div>
        </div>
        <div class="canvas-container">
            <div class="canvas-box"><span class="label-tag">Imagen Original (True Color)</span><canvas id="cvsOrig"></canvas></div>
            <div class="canvas-box"><span class="label-tag" id="lblRes">Preview Procesada</span><canvas id="cvsDest"></canvas></div>
        </div>
        <div class="code-block"><strong id="codeTitle">Loader Code:</strong><pre id="codeOutput">...</pre></div>
    </div>

    <script>
        // === CONFIGURACI√ìN Y TABLAS ===
        function getLuma(r, g, b) { return 0.299*r + 0.587*g + 0.114*b; }
        function getDistRGB(r1, g1, b1, r2, g2, b2) { 
            let rmean = (r1 + r2) / 2;
            let r = r1 - r2;
            let g = g1 - g2;
            let b = b1 - b2;
            return (((512+rmean)*r*r)>>8) + 4*g*g + (((767-rmean)*b*b)>>8);
        }
        function clamp(v) { return Math.max(0, Math.min(255, v)); }

        const MODE_DESCRIPTIONS = {
            cga: { title: "IBM PC CGA (Color Graphics Adapter)", text: "Genera archivos .BSV para GW-BASIC. Resoluci√≥n est√°ndar 320x200. Solo 4 colores (Paletas fijas HW). Ideal para DOS retro." },
            spec: { title: "ZX Spectrum (SCREEN$)", text: "Genera archivos .SCR. Resoluci√≥n est√°ndar 256x192. Simula 'Color Clash' (2 colores por bloque 8x8) y paleta fija de 15 colores." },
            cpc: { title: "Amstrad CPC (Pantalla Completa)", text: "Genera volcado .BIN (&C000). Modos: 0 (160x200, 16col), 1 (320x200, 4col), 2 (640x200, 2col). Paleta HW 27 colores." },
            "8bp": { title: "8BP Library (Sprite Injection)", text: "Recorta Sprites/Tiles y los inyecta en ASM (etiqueta _BEGIN_IMAGES). Usa formato 'Escalera Universal' de 8BP." },
            vga: { title: "PC VGA (Mode 13h)", text: "Genera archivos RAW .VGA. Resoluci√≥n est√°ndar 320x200 con 256 colores (1 byte/pixel). Paleta indexada." },
            pngAnalysis: { title: "Herramienta de An√°lisis y Reducci√≥n", text: "Analiza la imagen, reduce colores usando la paleta Amstrad CPC y exporta el resultado visual como un archivo .PNG est√°ndar." }
        };

        const PAL_SPEC = [{r:0,g:0,b:0}, {r:0,g:0,b:215}, {r:215,g:0,b:0}, {r:215,g:0,b:215}, {r:0,g:215,b:0}, {r:0,g:215,b:215}, {r:215,g:215,b:0}, {r:215,g:215,b:215}, {r:0,g:0,b:0}, {r:0,g:0,b:255}, {r:255,g:0,b:0}, {r:255,g:255,b:255}, {r:0,g:255,b:0}, {r:0,g:255,b:255}, {r:255,g:255,b:0}, {r:255,g:255,b:255}];
        const PAL_CGA = { p1: [{r:0,g:0,b:0}, {r:85,g:255,b:255}, {r:255,g:85,b:255}, {r:255,g:255,b:255}], p2: [{r:0,g:0,b:0}, {r:85,g:255,b:85}, {r:255,g:85,b:85}, {r:255,g:255,b:85}] };
        const CPC_HW = [{hw:0,r:0,g:0,b:0}, {hw:1,r:0,g:0,b:128}, {hw:2,r:0,g:0,b:255}, {hw:3,r:128,g:0,b:0}, {hw:4,r:128,g:0,b:128}, {hw:5,r:128,g:0,b:255}, {hw:6,r:255,g:0,b:0}, {hw:7,r:255,g:0,b:128}, {hw:8,r:255,g:0,b:255}, {hw:9,r:0,g:128,b:0}, {hw:10,r:0,g:128,b:128}, {hw:11,r:0,g:128,b:255}, {hw:12,r:128,g:128,b:0}, {hw:13,r:128,g:128,b:128}, {hw:14,r:128,g:128,b:255}, {hw:15,r:255,g:128,b:0}, {hw:16,r:255,g:128,b:128}, {hw:17,r:255,g:128,b:255}, {hw:18,r:0,g:255,b:0}, {hw:19,r:0,g:255,b:128}, {hw:20,r:0,g:255,b:255}, {hw:21,r:128,g:255,b:0}, {hw:22,r:128,g:255,b:128}, {hw:23,r:128,g:255,b:255}, {hw:24,r:255,g:255,b:0}, {hw:25,r:255,g:255,b:128}, {hw:26,r:255,g:255,b:255}];
        const BAYER4 = [[0,8,2,10],[12,4,14,6],[3,11,1,9],[15,7,13,5]];

        let specAttributes = new Uint8Array(768); 
        let state = { mode: '8bp', cpcSubMode: 0, img: null, fileName: 'image', asmContent: null, cpcPal: [], vgaPal: [], spritesToInject: [], uniqueColors: 0 };
        
        const cvsOrig = document.getElementById('cvsOrig'), cvsDest = document.getElementById('cvsDest');
        const ctxOrig = cvsOrig.getContext('2d'), ctxDest = cvsDest.getContext('2d', { willReadFrequently: true });

        function init() {
            const selX = document.getElementById('selSizeX');
            const selY = document.getElementById('selSizeY');
            for(let i=8; i<=128; i+=8) {
                const optX = new Option(i + " px", i);
                const optY = new Option(i + " px", i);
                if(i===16) { optX.selected = true; optY.selected = true; }
                selX.add(optX);
                selY.add(optY);
            }

            document.querySelectorAll('input[name="mode"]').forEach(r => r.addEventListener('change', e => updateUI(e.target.value)));
            
            document.getElementById('fileInput').addEventListener('change', e => {
                const f = e.target.files[0]; if (!f) return;
                state.fileName = f.name.split('.')[0].replace(/[^a-z0-9]/gi, '_');
                const img = new Image(); img.onload = () => { state.img = img; analyzeImage(); autoCalcGrid(); process(); }; 
                img.src = URL.createObjectURL(f);
            });

            document.getElementById('asmInput').addEventListener('change', e => {
                const f = e.target.files[0]; if(!f) return;
                const r = new FileReader(); r.onload = (ev) => {
                    const content = ev.target.result;
                    if (content.indexOf("_BEGIN_IMAGES") === -1) { alert("‚ùå ERROR: El ASM debe contener _BEGIN_IMAGES."); return; }
                    state.asmContent = content;
                    document.getElementById('asmStatus').innerText = "‚úÖ ASM Validado"; document.getElementById('asmStatus').style.display="block";
                }; r.readAsText(f);
            });

            ['selDither', 'selCgaPal', 'chkMono', 'selCpcMode', 'selVgaType', 'selSizeX', 'selSizeY', 'inpCols', 'inpRows', 'inpTargetColors', 'inpFinalW', 'inpFinalH', 'chkResize', 'chkCustomSize', 'chkSpriteSheet'].forEach(id => document.getElementById(id).addEventListener('change', process));
            document.getElementById('btnDownload').addEventListener('click', download);
            updateUI('8bp');
        }

        function extractRegion(sourceData, sourceW, x, y, w, h) {
            const res = new Uint8ClampedArray(w * h * 4);
            for(let row = 0; row < h; row++) {
                const srcIdx = ((y + row) * sourceW + x) * 4;
                const dstIdx = (row * w) * 4;
                for(let k = 0; k < w * 4; k++) { res[dstIdx + k] = sourceData[srcIdx + k]; }
            }
            return res;
        }

        function analyzeImage() {
            if(!state.img) return;
            const tCvs = document.createElement('canvas'); tCvs.width = state.img.width; tCvs.height = state.img.height;
            const tCtx = tCvs.getContext('2d'); tCtx.drawImage(state.img, 0, 0);
            const d = tCtx.getImageData(0,0,state.img.width,state.img.height).data;
            const uniqueSet = new Set();
            for(let i=0; i<d.length; i+=4) { if(d[i+3] > 0) { uniqueSet.add((d[i]<<16)|(d[i+1]<<8)|d[i+2]); } }
            state.uniqueColors = uniqueSet.size;
            document.getElementById('lblImgStats').innerText = `Dimensiones: ${state.img.width}x${state.img.height} | Colores: ${state.uniqueColors}`;
        }

        function autoCalcGrid() {
            if(!state.img || !document.getElementById('chkSpriteSheet').checked) return;
            const sw = parseInt(document.getElementById('selSizeX').value), sh = parseInt(document.getElementById('selSizeY').value);
            document.getElementById('inpCols').value = Math.max(1, Math.floor(state.img.width / sw));
            document.getElementById('inpRows').value = Math.max(1, Math.floor(state.img.height / sh));
        }

        function updateUI(m) {
            state.mode = m;
            const info = MODE_DESCRIPTIONS[m];
            document.getElementById('descTitle').innerText = info.title;
            document.getElementById('descText').innerText = info.text;
            document.getElementById('cgaControls').style.display = (m==='cga') ? 'block' : 'none';
            document.getElementById('specControls').style.display = (m==='spec') ? 'block' : 'none';
            document.getElementById('cpcControls').style.display = (m==='cpc' || m==='8bp') ? 'block' : 'none';
            document.getElementById('vgaControls').style.display = (m==='vga') ? 'block' : 'none';
            document.getElementById('row8bp').style.display = (m==='8bp') ? 'flex' : 'none';
            document.getElementById('rowPngAnalysis').style.display = (m==='pngAnalysis') ? 'flex' : 'none';
            process();
        }

        function process() {
            if (!state.img) return;
            document.getElementById('status').innerText = "Procesando...";
            state.spritesToInject = []; 
            
            setTimeout(() => {
                let w, h, cssClass;
                state.cpcSubMode = parseInt(document.getElementById('selCpcMode').value);
                const isFull = document.getElementById('chkResize').checked;
                const isSheet = document.getElementById('chkSpriteSheet').checked;
                const useCustomSize = document.getElementById('chkCustomSize').checked;

                if (state.mode === 'pngAnalysis') { w = isFull ? state.img.width : 320; h = isFull ? state.img.height : 200; cssClass = 'aspect-vga'; }
                else if (state.mode === '8bp') {
                    cssClass = 'aspect-cpc-m0'; 
                    if (isSheet && !isFull) {
                        const sw = parseInt(document.getElementById('selSizeX').value), sh = parseInt(document.getElementById('selSizeY').value);
                        w = sw * parseInt(document.getElementById('inpCols').value); h = sh * parseInt(document.getElementById('inpRows').value);
                    } else if (isFull) { w = state.img.width; h = state.img.height; }
                    else { w = parseInt(document.getElementById('selSizeX').value); h = parseInt(document.getElementById('selSizeY').value); }
                } 
                else if (state.mode === 'cpc') { w = state.cpcSubMode === 0 ? 160 : 320; h = 200; cssClass = state.cpcSubMode === 0 ? 'aspect-cpc-m0' : 'aspect-cpc-m1'; }
                else if (state.mode === 'spec') { w = 256; h = 192; cssClass = 'aspect-spec'; }
                else if (state.mode === 'vga') { w = 320; h = 200; cssClass = 'aspect-vga'; }
                else { w = 320; h = 200; cssClass = 'aspect-cga'; }

                if (useCustomSize) { w = parseInt(document.getElementById('inpFinalW').value); h = parseInt(document.getElementById('inpFinalH').value); }
                
                cvsOrig.width = w; cvsOrig.height = h;
                ctxOrig.fillStyle = '#000000'; ctxOrig.fillRect(0,0,w,h);

                if (isFull) { ctxOrig.drawImage(state.img, 0, 0, w, h); }
                else {
                    if (document.getElementById('chkResize').checked) { ctxOrig.drawImage(state.img, 0, 0, w, h); }
                    else {
                        const scale = Math.min(w/state.img.width, h/state.img.height);
                        const dw = state.img.width * scale, dh = state.img.height * scale;
                        ctxOrig.drawImage(state.img, (w-dw)/2, (h-dh)/2, dw, dh);
                    }
                }

                const rawData = ctxOrig.getImageData(0,0,w,h);
                const procData = new Uint8ClampedArray(rawData.data);
                let activePalette = [];

                if (state.mode === 'pngAnalysis') { state.cpcPal = detectCpcPalette(ctxOrig, w, h, parseInt(document.getElementById('inpTargetColors').value)); activePalette = state.cpcPal; }
                else if (state.mode === 'cpc' || state.mode === '8bp') { state.cpcPal = detectCpcPalette(ctxOrig, w, h, state.cpcSubMode === 0 ? 16 : 4); activePalette = state.cpcPal; }
                else if (state.mode === 'spec') activePalette = PAL_SPEC;
                else if (state.mode === 'vga') { state.vgaPal = detectVgaPalette(ctxOrig, w, h); activePalette = state.vgaPal; }
                else activePalette = PAL_CGA[document.getElementById('selCgaPal').value];

                const algo = document.getElementById('selDither').value;
                if (state.mode === 'spec') { if (document.getElementById('chkMono').checked) applyMonochrome(procData); else applySpectrumV11(procData, w, h, algo); }
                else {
                    if(algo === 'fs') applyFloydSteinberg(procData, activePalette, w, h);
                    else if(algo === 'bayer') applyBayer(procData, activePalette, w, h);
                    else applyNearest(procData, activePalette);
                }

                cvsDest.width = w; cvsDest.height = h;
                ctxDest.putImageData(new ImageData(new Uint8ClampedArray(procData), w, h), 0, 0);
                document.getElementById('status').innerText = "‚úÖ Listo";
                document.getElementById('btnDownload').disabled = false;
                updateCodeBlock();
            }, 10);
        }

        // --- PALETAS Y PACKERS ---
        function detectCpcPalette(ctx, w, h, limit) {
            const d = ctx.getImageData(0,0,w,h).data, hwCounts = {};
            for(let i=0; i<d.length; i+=4) {
                if(d[i+3] < 128) continue;
                let bHw=0, minD=Infinity;
                for(let c of CPC_HW) { let dist = getDistRGB(d[i],d[i+1],d[i+2],c.r,c.g,c.b); if(dist < minD){minD=dist; bHw=c.hw;} }
                hwCounts[bHw] = (hwCounts[bHw]||0)+1;
            }
            const sorted = Object.keys(hwCounts).sort((a,b)=>hwCounts[b]-hwCounts[a]).slice(0,limit);
            const pal = sorted.map((hw,i)=>{ const c=CPC_HW.find(x=>x.hw==hw); return {index:i, hw:c.hw, r:c.r, g:c.g, b:c.b}; });
            while(pal.length < limit) pal.push({index:pal.length, hw:0, r:0, g:0, b:0});
            return pal;
        }

        function detectVgaPalette(ctx, w, h) { let p=[]; for(let i=0;i<256;i++) p.push({r:i,g:i,b:i,index:i}); return p; }
        function getClosestIdx(r,g,b, pal) { let min=Infinity, idx=0; for(let i=0;i<pal.length;i++) { let d=getDistRGB(r,g,b,pal[i].r,pal[i].g,pal[i].b); if(d<min){min=d;idx=i;} } return idx; }
        function applyNearest(d, pal) { for(let i=0; i<d.length; i+=4) { const c=pal[getClosestIdx(d[i],d[i+1],d[i+2],pal)]; d[i]=c.r; d[i+1]=c.g; d[i+2]=c.b; } }
        function applyMonochrome(d) { for(let i=0; i<d.length; i+=4) { const v=getLuma(d[i],d[i+1],d[i+2])>127?255:0; d[i]=d[i+1]=d[i+2]=v; } }

        function applySpectrumV11(data, w, h, algo) {
            const isMono = document.getElementById('chkMono').checked;
            for (let by=0; by<h; by+=8) {
                for (let bx=0; bx<w; bx+=8) {
                    let ink, pap;
                    if(isMono) { ink=0; pap=7; } // Tinta Negra (0), Fondo Blanco (7)
                    else {
                        let counts = {};
                        for(let y=0;y<8;y++) for(let x=0;x<8;x++) {
                            let i=((by+y)*w+(bx+x))*4; let id=getClosestIdx(data[i],data[i+1],data[i+2],PAL_SPEC);
                            counts[id]=(counts[id]||0)+1;
                        }
                        let sorted = Object.keys(counts).sort((a,b)=>counts[b]-counts[a]);
                        ink=parseInt(sorted[0]); pap=sorted[1]?parseInt(sorted[1]):ink;
                    }
                    specAttributes[(by/8)*32+(bx/8)] = ((pap&7)<<3)|(ink&7);
                    for(let y=0;y<8;y++) for(let x=0;x<8;x++) {
                        let i=((by+y)*w+(bx+x))*4;
                        const dInk=getDistRGB(data[i],data[i+1],data[i+2],PAL_SPEC[ink].r,PAL_SPEC[ink].g,PAL_SPEC[ink].b);
                        const dPap=getDistRGB(data[i],data[i+1],data[i+2],PAL_SPEC[pap].r,PAL_SPEC[pap].g,PAL_SPEC[pap].b);
                        const f=dInk<dPap?PAL_SPEC[ink]:PAL_SPEC[pap];
                        data[i]=f.r; data[i+1]=f.g; data[i+2]=f.b;
                    }
                }
            }
        }

        function applyFloydSteinberg(d, pal, w, h) {
            for(let y=0;y<h;y++) for(let x=0;x<w;x++) {
                let i=(y*w+x)*4, c=pal[getClosestIdx(d[i],d[i+1],d[i+2],pal)];
                let er=d[i]-c.r, eg=d[i+1]-c.g, eb=d[i+2]-c.b;
                d[i]=c.r; d[i+1]=c.g; d[i+2]=c.b;
                if(x+1<w) addErr(d,(y*w+x+1)*4,er,eg,eb,7/16);
                if(x>0&&y+1<h) addErr(d,((y+1)*w+x-1)*4,er,eg,eb,3/16);
                if(y+1<h) addErr(d,((y+1)*w+x)*4,er,eg,eb,5/16);
                if(x+1<w&&y+1<h) addErr(d,((y+1)*w+x+1)*4,er,eg,eb,1/16);
            }
        }
        function addErr(d,i,er,eg,eb,f) { d[i]=clamp(d[i]+er*f); d[i+1]=clamp(d[i+1]+eg*f); d[i+2]=clamp(d[i+2]+eb*f); }
        function applyBayer(d, pal, w, h) {
            for(let y=0; y<h; y++) for(let x=0; x<w; x++) {
                let i=(y*w+x)*4, t=(BAYER4[y%4][x%4]/16)-0.5;
                let c=pal[getClosestIdx(clamp(d[i]+t*40),clamp(d[i+1]+t*40),clamp(d[i+2]+t*40),pal)];
                d[i]=c.r; d[i+1]=c.g; d[i+2]=c.b;
            }
        }

        function packMode0(c1, c2) { let b=0; if(c1&1)b|=2; if(c1&2)b|=8; if(c1&4)b|=32; if(c1&8)b|=128; if(c2&1)b|=1; if(c2&2)b|=4; if(c2&4)b|=16; if(c2&8)b|=64; return b; }
        function packMode1(c1,c2,c3,c4) { let b=0; if(c1&2)b|=128; if(c1&1)b|=8; if(c2&2)b|=64; if(c2&1)b|=4; if(c3&2)b|=32; if(c3&1)b|=2; if(c4&2)b|=16; if(c4&1)b|=1; return b; }

        function genCpcBin(px) {
            const buf = new Uint8Array(16384); const sub = state.cpcSubMode;
            for(let y=0; y<200; y++) {
                let la = ((y>>3)*80) + ((y&7)*2048);
                for(let x=0; x<80; x++) {
                    let b = 0;
                    if(sub===0) b=packMode0(getClosestIdx(px[(y*160+x*2)*4],px[(y*160+x*2)*4+1],px[(y*160+x*2)*4+2],state.cpcPal), getClosestIdx(px[(y*160+x*2+1)*4],px[(y*160+x*2+1)*4+1],px[(y*160+x*2+1)*4+2],state.cpcPal));
                    else if(sub===1) b=packMode1(getClosestIdx(px[(y*320+x*4)*4],px[(y*320+x*4)*4+1],px[(y*320+x*4)*4+2],state.cpcPal), getClosestIdx(px[(y*320+x*4+1)*4],px[(y*320+x*4+1)*4+1],px[(y*320+x*4+1)*4+2],state.cpcPal), getClosestIdx(px[(y*320+x*4+2)*4],px[(y*320+x*4+2)*4+1],px[(y*320+x*4+2)*4+2],state.cpcPal), getClosestIdx(px[(y*320+x*4+3)*4],px[(y*320+x*4+3)*4+1],px[(y*320+x*4+3)*4+2],state.cpcPal));
                    buf[la+x] = b;
                }
            } return buf;
        }

        function genSpecScr(px) {
            const isMono = document.getElementById('chkMono').checked;
            const buf = new Uint8Array(6912); 
            buf.fill(0,0,6144);
            // Si es Mono: Fondo Blanco (Atributo 56: Paper 7, Ink 0). Si no: Fondo Negro (56: Paper 7, Ink 0 invertido).
            buf.fill(isMono ? 56 : 56, 6144, 6912); 

            for(let by=0; by<24; by++) for(let bx=0; bx<32; bx++) {
                let at;
                if(isMono) { at = 56; } 
                else { at = specAttributes[by*32+bx]; }
                
                buf[6144+by*32+bx] = at;
                let ink = PAL_SPEC[at&7], pap = PAL_SPEC[(at>>3)&7];
                for(let y=0; y<8; y++) {
                    let ad = (((by*8+y)>>6)<<11) + (((by*8+y)&7)<<8) + (((by*8+y)>>3&7)<<5);
                    let b = 0;
                    for(let x=0; x<8; x++) {
                        let i = ((by*8+y)*256+(bx*8+x))*4;
                        if(getDistRGB(px[i],px[i+1],px[i+2], ink.r, ink.g, ink.b) < getDistRGB(px[i],px[i+1],px[i+2], pap.r, pap.g, pap.b)) b |= (1<<(7-x));
                    }
                    buf[ad+bx] = b;
                }
            } return buf;
        }

        function genCgaBsave(px) {
            const buf = new Uint8Array(16391); buf[0]=0xFD; buf.set([0,0,0,184,0,64],1);
            const pal = PAL_CGA[document.getElementById('selCgaPal').value];
            for(let y=0; y<200; y++) {
                let off = 7 + (y%2?0x2000:0) + (Math.floor(y/2)*80);
                for(let x=0; x<80; x++) {
                    let b = 0;
                    for(let p=0; p<4; p++) b |= (getClosestIdx(px[(y*320+x*4+p)*4],px[(y*320+x*4+p)*4+1],px[(y*320+x*4+p)*4+2],pal) << (6-p*2));
                    buf[off+x] = b;
                }
            } return buf;
        }

        function download() {
            const px = ctxDest.getImageData(0,0,cvsDest.width,cvsDest.height).data;
            let blob, ext = ".BIN";
            if (state.mode === '8bp') {
                if(!state.asmContent) { alert("Carga el ASM primero"); return; }
                blob = new Blob([injectOneSprite(state.asmContent, {label:state.fileName.toUpperCase(), w:cvsDest.width, h:cvsDest.height, pixels:px}, 16)], {type:'text/plain'}); ext=".asm";
            }
            else if (state.mode === 'spec') { blob = new Blob([genSpecScr(px)], {type:'application/octet-stream'}); ext=".SCR"; }
            else if (state.mode === 'cpc') { blob = new Blob([genCpcBin(px)], {type:'application/octet-stream'}); ext=".BIN"; }
            else if (state.mode === 'cga') { blob = new Blob([genCgaBsave(px)], {type:'application/octet-stream'}); ext=".BSV"; }
            else if (state.mode === 'vga') { blob = new Blob([px], {type:'application/octet-stream'}); ext=".VGA"; }
            else if (state.mode === 'pngAnalysis') { cvsDest.toBlob(b => { const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=state.fileName+".png"; a.click(); }); return; }
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = state.fileName + ext; a.click();
        }

        function injectOneSprite(asm, sprite, id) {
            const sub = parseInt(document.getElementById('selCpcMode').value);
            const wBytes = Math.ceil(sprite.w / (sub === 0 ? 2 : 4));
            let hex = `\tDB ${wBytes}, ${sprite.h}\n`;
            for(let y=0; y<sprite.h; y++) {
                hex += "\tDB "; let r=[];
                for(let x=0; x<sprite.w; ) {
                    let b = 0;
                    if(sub === 0) { 
                        b = packMode0(getClosestIdx(sprite.pixels[(y*sprite.w+x)*4],sprite.pixels[(y*sprite.w+x)*4+1],sprite.pixels[(y*sprite.w+x)*4+2],state.cpcPal), 
                                      getClosestIdx(sprite.pixels[(y*sprite.w+x+1)*4],sprite.pixels[(y*sprite.w+x+1)*4+1],sprite.pixels[(y*sprite.w+x+1)*4+2],state.cpcPal)); 
                        x += 2; 
                    } else { 
                        b = packMode1(getClosestIdx(sprite.pixels[(y*sprite.w+x)*4],sprite.pixels[(y*sprite.w+x)*4+1],sprite.pixels[(y*sprite.w+x)*4+2],state.cpcPal),
                                      getClosestIdx(sprite.pixels[(y*sprite.w+x+1)*4],sprite.pixels[(y*sprite.w+x+1)*4+1],sprite.pixels[(y*sprite.w+x+1)*4+2],state.cpcPal),
                                      getClosestIdx(sprite.pixels[(y*sprite.w+x+2)*4],sprite.pixels[(y*sprite.w+x+2)*4+1],sprite.pixels[(y*sprite.w+x+2)*4+2],state.cpcPal),
                                      getClosestIdx(sprite.pixels[(y*sprite.w+x+3)*4],sprite.pixels[(y*sprite.w+x+3)*4+1],sprite.pixels[(y*sprite.w+x+3)*4+2],state.cpcPal));
                        x += 4; 
                    }
                    r.push("&" + b.toString(16).toUpperCase().padStart(2,'0'));
                }
                hex += r.join(", ") + "\n";
            }
            const iS = asm.indexOf("_BEGIN_IMAGES"), iE = asm.indexOf("_END_IMAGES");
            return asm.substring(0, iS+13) + `\n${sprite.label} ; ${id}\n${hex}` + asm.substring(iE);
        }

        function updateCodeBlock() {
            const o = document.getElementById('codeOutput');
            if(state.mode==='cpc') o.innerText = `10 MODE ${state.cpcSubMode}\n20 MEMORY &3FFF: LOAD "${state.fileName.toUpperCase()}.BIN",&C000\n30 CALL &C000`;
            else if(state.mode==='spec') o.innerText = `10 LOAD "" SCREEN$`;
            else o.innerText = "...";
        }

        init();
    </script>
</body>
</html>
